#!/bin/sh

# ========================================
# Smuppy Pre-commit Security & Quality Checks
# ========================================

set -e

echo "üîç Running pre-commit checks..."

# Run lint-staged for code quality
echo "üìù Running lint-staged..."
npx lint-staged

# ========================================
# SAST - Security Scanning
# ========================================

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json)$' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "üîí Running security checks on staged files..."

  # Check for AWS keys (AKIA pattern)
  if echo "$STAGED_FILES" | xargs grep -lE 'AKIA[0-9A-Z]{16}' 2>/dev/null; then
    echo "‚ùå ERROR: AWS Access Key detected!"
    exit 1
  fi

  # Check for AWS Secret keys (pattern + keyword combo)
  # Using --no-run-if-empty to prevent false positives when no files match first grep
  LONG_STRINGS=$(echo "$STAGED_FILES" | xargs grep -lE '[A-Za-z0-9/+=]{40}' 2>/dev/null || true)
  if [ -n "$LONG_STRINGS" ]; then
    if echo "$LONG_STRINGS" | xargs grep -lE 'aws_secret|secret_access_key|AWS_SECRET' 2>/dev/null; then
      echo "‚ùå ERROR: AWS Secret Key pattern detected!"
      exit 1
    fi
  fi

  # Check for private keys
  if echo "$STAGED_FILES" | xargs grep -l 'PRIVATE KEY' 2>/dev/null; then
    echo "‚ùå ERROR: Private key detected!"
    exit 1
  fi

  # Check for Stripe keys
  if echo "$STAGED_FILES" | xargs grep -lE 'sk_live_[a-zA-Z0-9]{24}' 2>/dev/null; then
    echo "‚ùå ERROR: Stripe live key detected!"
    exit 1
  fi

  if echo "$STAGED_FILES" | xargs grep -lE 'pk_live_[a-zA-Z0-9]{24}' 2>/dev/null; then
    echo "‚ùå ERROR: Stripe live publishable key detected!"
    exit 1
  fi

  # Check for Google API keys
  if echo "$STAGED_FILES" | xargs grep -lE 'AIza[0-9A-Za-z_-]{35}' 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: Google API Key pattern detected - verify it's not a production key"
  fi

  # Check for JWT secrets
  if echo "$STAGED_FILES" | xargs grep -lE '(jwt_secret|JWT_SECRET|jwtSecret).*=.*["\047][a-zA-Z0-9+/=]{20,}["\047]' 2>/dev/null; then
    echo "‚ùå ERROR: Hardcoded JWT secret detected!"
    exit 1
  fi

  # Check for database connection strings with passwords
  if echo "$STAGED_FILES" | xargs grep -lE '(postgres|mysql|mongodb)://[^:]+:[^@]+@' 2>/dev/null; then
    echo "‚ùå ERROR: Database connection string with credentials detected!"
    exit 1
  fi

  # Check for hardcoded passwords
  if echo "$STAGED_FILES" | xargs grep -lE '(password|passwd|pwd).*=.*["\047].{8,}["\047]' 2>/dev/null | grep -v test | grep -v spec | grep -v mock; then
    echo "‚ö†Ô∏è  WARNING: Possible hardcoded password detected - review before committing"
  fi

  # ========================================
  # SAST - Code Pattern Checks
  # ========================================

  # Check for eval() usage (code injection risk)
  if echo "$STAGED_FILES" | xargs grep -lE '\beval\s*\(' 2>/dev/null | grep -v test | grep -v spec; then
    echo "‚ö†Ô∏è  WARNING: eval() usage detected - potential code injection risk"
  fi

  # Check for dangerouslySetInnerHTML (XSS risk in React)
  if echo "$STAGED_FILES" | xargs grep -l 'dangerouslySetInnerHTML' 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: dangerouslySetInnerHTML detected - ensure input is sanitized"
  fi

  # Check for SQL string concatenation (SQL injection risk)
  if echo "$STAGED_FILES" | xargs grep -lE 'SELECT.*\+.*FROM|INSERT.*\+.*INTO|UPDATE.*\+.*SET|DELETE.*\+.*FROM' 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: SQL string concatenation detected - use parameterized queries"
  fi

  # Check for shell command execution
  if echo "$STAGED_FILES" | xargs grep -lE 'exec\(|execSync\(|spawn\(|child_process' 2>/dev/null | grep -v test | grep -v spec; then
    echo "‚ö†Ô∏è  WARNING: Shell command execution detected - review for command injection"
  fi
fi

# ========================================
# Dependency Security Check
# ========================================

echo "üì¶ Checking for vulnerable dependencies..."

# Check root package.json for vulnerabilities (non-blocking)
# Note: npm audit can be slow, so we only warn and don't block commits
if [ -f "package.json" ] && command -v npm &> /dev/null; then
  # Quick check - just see if audit has any output
  AUDIT_RESULT=$(npm audit --audit-level=critical 2>&1 || true)
  if echo "$AUDIT_RESULT" | grep -qi "critical"; then
    echo "‚ö†Ô∏è  WARNING: Critical vulnerabilities detected. Run 'npm audit' for details"
  fi
fi

# ========================================
# TypeScript Type Check (optional but recommended)
# ========================================

echo "üî∑ Running TypeScript check..."
npx tsc --noEmit

echo "‚úÖ Pre-commit checks passed."
